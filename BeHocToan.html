
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To√°n L·ªõp 1 - Th·∫ø Gi·ªõi Ph√©p Thu·∫≠t (Ch√¢n Tr·ªùi S√°ng T·∫°o)</title>
	<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');
        body {
            font-family: 'Fredoka', sans-serif;
            background: #e0f2fe;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            user-select: none;
            overflow-x: hidden;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 3rem;
            border: 8px solid #fff;
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.15);
        }
        .hidden-view { display: none !important; }
        
        .btn-game {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-bottom: 6px solid rgba(0,0,0,0.1);
        }
        .btn-game:active { transform: translateY(4px); border-bottom-width: 2px; }
        
        .drag-item { cursor: grab; touch-action: none; }
        .drop-zone {
            min-height: 80px;
            border: 3px dashed #cbd5e1;
            border-radius: 1.5rem;
            display: flex;
            gap: 10px;
            padding: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .correct-pulse { animation: pulse 0.5s infinite; color: #22c55e; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #93c5fd; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #60a5fa; }
    </style>
</head>

<!-- ===== AUDIO ASSETS (UPDATED LINKS) ===== -->
<!-- Nh·∫°c n·ªÅn: Vui t∆∞∆°i, nh·∫π nh√†ng (Link ·ªïn ƒë·ªãnh h∆°n) -->
<audio id="bg-music" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3?filename=background-music-for-youtube-videos-funny-comedy-children-music-11448.mp3" type="audio/mpeg">
</audio>
<!-- Hi·ªáu ·ª©ng Click: Ti·∫øng Pop -->
<audio id="sfx-click">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=pop-39222.mp3" type="audio/mpeg">
    <!-- D·ª± ph√≤ng √¢m thanh click ng·∫Øn g·ªçn -->
    <source src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" type="audio/ogg">
</audio>

<body class="min-h-screen flex items-center justify-center p-4">
    <canvas id="confetti-canvas"></canvas>
    <div id="app-container" class="w-full max-w-6xl glass-panel p-6 md:p-8 relative min-h-[90vh] flex flex-col animate__animated animate__fadeIn">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4 cursor-pointer group" onclick="goHome()">
                <div class="bg-gradient-to-br from-blue-400 to-blue-600 p-4 rounded-3xl shadow-xl group-hover:rotate-6 transition-transform">
                    <span class="text-4xl text-white">‚ú®</span>
                </div>
                <div>
                    <h1 class="text-3xl font-black text-blue-600 leading-tight uppercase tracking-tight">To√°n H·ªçc Vui</h1>
                    <p class="text-xs text-blue-400 font-bold tracking-widest uppercase">Ch√¢n Tr·ªùi S√°ng T·∫°o - HK2.</p>
		            <p class="text-[10px] text-red-500 font-bold tracking-widest uppercase">B·∫¢N QUY·ªÄN: TR·∫¶N QUANG ƒê·∫†T - TR∆Ø·ªúNG TH T√ÇN THU·∫¨N 3.</p>
                </div>
            </div>
            <div id="user-info" class="hidden flex items-center gap-4 bg-white px-5 py-2 rounded-full border-2 border-blue-50 shadow-sm">
                <div class="w-8 h-8 bg-orange-400 rounded-full flex items-center justify-center text-white font-bold"> üë¶ </div>
                <span id="display-name" class="font-bold text-blue-700 text-sm"></span>
                <button onclick="logout()" class="text-[10px] text-red-500 font-black hover:scale-110 transition-transform uppercase">Tho√°t</button>
            </div>
        </header>

        <!-- VIEW LANDING -->
        <div id="view-landing" class="flex-1 flex flex-col items-center justify-center gap-10 text-center">
            <div class="animate__animated animate__bounceIn">
                <h2 class="text-6xl md:text-8xl font-black text-blue-500 drop-shadow-sm">XIN CH√ÄO!</h2>
                <p class="text-gray-400 text-xl font-medium mt-4">H√¥m nay b√© mu·ªën kh√°m ph√° g√¨ n√†o?</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-2xl">
                <button onclick="switchView('view-student-login')" class="group p-10 bg-white rounded-[3.5rem] border-4 border-blue-100 shadow-xl hover:border-blue-400 transition-all">
                    <div class="text-8xl mb-6 group-hover:scale-110 transition-transform"> üéí </div>
                    <span class="text-2xl font-black text-blue-600 uppercase block">B√© H·ªçc T·∫≠p</span>
                    <span class="text-xs text-gray-400 font-bold uppercase mt-2 block">Luy·ªán t·∫≠p theo SGK</span>
                </button>
                <button onclick="switchView('view-teacher-login')" class="group p-10 bg-white rounded-[3.5rem] border-4 border-rose-100 shadow-xl hover:border-rose-400 transition-all">
                    <div class="text-8xl mb-6 group-hover:scale-110 transition-transform"> üë©‚Äçüè´ </div>
                    <span class="text-2xl font-black text-rose-600 uppercase block">Gi√°o Vi√™n</span>
                    <span class="text-xs text-gray-400 font-bold uppercase mt-2 block">Qu·∫£n l√Ω l·ªõp h·ªçc</span>
                </button>
            </div>
        </div>

        <!-- VIEW STUDENT LOGIN -->
        <div id="view-student-login" class="hidden-view flex-1 flex flex-col items-center justify-center animate__animated animate__zoomIn">
            <div class="w-full max-w-md bg-white p-10 rounded-[4rem] shadow-2xl text-center border-b-[10px] border-blue-500">
                <div class="text-6xl mb-4"> üåü </div>
                <h2 class="text-3xl font-black text-blue-600 mb-8 uppercase">T√™n c·ªßa b√© l√† g√¨?</h2>
                <input type="text" id="student-name" class="w-full p-5 rounded-3xl border-4 border-blue-50 mb-4 focus:border-blue-300 outline-none text-2xl font-black text-center text-blue-600" placeholder="Nh·∫≠p t√™n b√©...">
                <input type="text" id="student-class" class="w-full p-5 rounded-3xl border-4 border-blue-50 mb-8 focus:border-blue-300 outline-none text-2xl font-black text-center text-blue-600" placeholder="L·ªõp c·ªßa b√© (VD: 1A)">
                <button onclick="studentLogin()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-black py-6 rounded-3xl text-2xl shadow-xl hover:brightness-110 active:scale-95 transition-all">B·∫ÆT ƒê·∫¶U NGAY üöÄ </button>
            </div>
        </div>

        <!-- VIEW TEACHER LOGIN -->
        <div id="view-teacher-login" class="hidden-view flex-1 flex flex-col items-center justify-center animate__animated animate__fadeIn">
            <div class="w-full max-w-sm bg-white p-10 rounded-[3rem] shadow-2xl text-center">
                <h2 class="text-3xl font-black text-rose-500 mb-8 uppercase">X√°c th·ª±c</h2>
                <input type="password" id="teacher-pass" class="w-full p-5 rounded-2xl border-4 border-rose-50 mb-8 focus:border-rose-300 outline-none text-2xl font-bold text-center" placeholder="M·∫≠t m√£">
                <button onclick="teacherLogin()" class="w-full bg-rose-500 text-white font-black py-5 rounded-2xl text-xl shadow-lg active:scale-95">V√ÄO H·ªÜ TH·ªêNG</button>
                <button onclick="switchView('view-landing')" class="mt-6 text-gray-400 font-bold text-sm uppercase hover:text-rose-500 transition-colors">Quay l·∫°i</button>
            </div>
        </div>

        <!-- VIEW LESSON SELECT -->
        <div id="view-lesson-select" class="hidden-view flex-1 flex flex-col animate__animated animate__fadeIn h-full">
            <div class="flex justify-between items-end mb-6 px-4">
                <h3 id="menu-title" class="text-3xl font-black text-blue-500 uppercase tracking-tight">H√†nh Tr√¨nh Ki·∫øn Th·ª©c</h3>
                <span id="menu-subtitle" class="text-gray-400 font-bold text-sm uppercase">H·ªçc k·ª≥ II</span>
            </div>
            <div class="flex-1 overflow-y-auto pr-2 pb-10">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="lesson-grid"></div>
            </div>
        </div>

        <!-- VIEW GAME -->
        <div id="view-game" class="hidden-view flex-1 flex flex-col">
            <div class="flex items-center gap-6 mb-8">
                <button onclick="confirmExit()" class="text-3xl p-3 bg-white rounded-2xl shadow-md hover:scale-110 transition-transform"> üè† </button>
                <div class="flex-1 bg-gray-100 h-6 rounded-full p-1 shadow-inner border border-white">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-400 to-cyan-400 rounded-full transition-all duration-500 shadow-md" style="width: 0%"></div>
                </div>
                <div class="flex flex-col items-end">
                    <span id="question-counter" class="font-black text-blue-600 text-lg"></span>
                    <span id="difficulty-tag" class="text-[9px] font-black uppercase px-2 py-0.5 rounded-full"></span>
                </div>
            </div>
            <div class="flex-1 flex flex-col items-center">
                <div id="question-container" class="w-full bg-white p-8 md:p-12 rounded-[4rem] shadow-xl border-4 border-blue-50 text-center mb-10 min-h-[300px] flex flex-col justify-center animate__animated animate__fadeIn">
                    <div id="visual-aid" class="mb-6 flex justify-center flex-wrap gap-2 text-6xl"></div>
                    <h3 id="question-text" class="text-2xl md:text-4xl font-black text-gray-800 leading-relaxed"></h3>
                </div>

                <div id="interaction-area" class="w-full">
                    <div id="options-grid" class="grid grid-cols-2 gap-4 hidden-view"></div>
                    <div id="fill-input-area" class="flex justify-center gap-4 hidden-view">
                        <input type="number" id="ans-input" class="w-40 p-6 rounded-3xl border-4 border-blue-200 text-5xl font-black text-center text-blue-600 outline-none focus:border-blue-500 shadow-lg" placeholder="?">
                        <button onclick="submitFillAnswer()" class="bg-blue-600 text-white px-8 rounded-3xl font-black text-xl shadow-lg active:scale-95">G·ª¨I</button>
                    </div>
                    <div id="compare-area" class="flex justify-center gap-6 hidden-view">
                        <button onclick="checkCompare('<')" class="btn-game bg-white p-8 rounded-3xl text-5xl font-black border-4 border-blue-100 w-24 shadow-xl text-blue-500">&lt;</button>
                        <button onclick="checkCompare('=')" class="btn-game bg-white p-8 rounded-3xl text-5xl font-black border-4 border-blue-100 w-24 shadow-xl text-purple-500">=</button>
                        <button onclick="checkCompare('>')" class="btn-game bg-white p-8 rounded-3xl text-5xl font-black border-4 border-blue-100 w-24 shadow-xl text-orange-500">&gt;</button>
                    </div>
                    <div id="sort-area" class="hidden-view space-y-6">
                        <div id="sort-pool" class="drop-zone bg-blue-50"></div>
                        <div id="sort-target" class="drop-zone bg-white border-blue-200 relative">
                            <span class="absolute top-2 left-4 text-xs text-gray-300 font-bold uppercase pointer-events-none">Th·∫£ v√†o ƒë√¢y</span>
                        </div>
                        <div class="text-center">
                            <button onclick="submitSortAnswer()" class="bg-blue-600 text-white px-12 py-4 rounded-3xl font-black text-xl shadow-lg active:scale-95">X√ÅC NH·∫¨N</button>
                        </div>
                    </div>
                </div>

                <div id="feedback-area" class="hidden-view mt-10 flex flex-col items-center gap-6 w-full animate__animated animate__bounceInUp">
                    <div id="feedback-msg" class="text-3xl font-black text-blue-600 tracking-tighter"></div>
                    <button id="next-btn" class="px-16 py-5 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-3xl font-black text-2xl shadow-2xl hover:brightness-110 active:scale-95">TI·∫æP THEO ‚ú®</button>
                </div>
            </div>
        </div>

        <!-- VIEW RESULT -->
        <div id="view-result" class="hidden-view flex-1 flex flex-col items-center justify-center text-center animate__animated animate__tada">
            <div id="result-emoji" class="text-[10rem] mb-6"></div>
            <h2 id="result-title" class="text-5xl font-black text-blue-600 mb-4"></h2>
            <div class="bg-white p-8 rounded-[3rem] shadow-xl border-4 border-blue-50 mb-10 w-full max-w-sm">
                <p class="text-gray-400 font-bold uppercase tracking-widest text-sm mb-2">ƒêi·ªÉm s·ªë c·ªßa b√©</p>
                <p id="final-score" class="text-7xl font-black text-blue-500"></p>
            </div>
            <div class="flex gap-4 w-full max-w-md">
                <button onclick="switchView('view-lesson-select')" class="flex-1 py-6 bg-blue-600 text-white rounded-[2rem] font-black text-xl shadow-xl hover:scale-105 transition-transform">CH∆†I TI·∫æP</button>
                <button onclick="goHome()" class="flex-1 py-6 bg-white border-4 border-blue-100 text-blue-600 rounded-[2rem] font-black text-xl shadow-md hover:scale-105 transition-transform">TRANG CH·ª¶</button>
            </div>
        </div>

        <!-- TEACHER DASHBOARD -->
        <div id="view-teacher-dashboard" class="hidden-view flex-1 flex flex-col animate__animated animate__fadeIn">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-rose-600">B·∫¢NG V√ÄNG L·ªöP H·ªåC</h2>
                <div class="flex gap-3">
                    <button onclick="openChangePassModal()" class="bg-orange-400 text-white px-6 py-2 rounded-2xl text-sm font-black shadow-sm">ƒê·ªîI M·∫¨T M√É</button>
                    <button onclick="exportData()" class="bg-green-500 text-white px-6 py-2 rounded-2xl text-sm font-black shadow-sm">XU·∫§T D·ªÆ LI·ªÜU</button>
                </div>
            </div>
            <div id="change-pass-section" class="hidden mb-8 bg-orange-50 p-8 rounded-[3rem] border-4 border-orange-100">
                <h3 class="font-black text-orange-600 mb-6 uppercase text-sm">C√†i ƒë·∫∑t b·∫£o m·∫≠t</h3>
                <div class="flex flex-wrap gap-4 items-end">
                    <div class="flex-1 min-w-[240px]">
                        <input type="password" id="new-teacher-pass" class="w-full p-4 rounded-2xl border-2 border-orange-200 outline-none font-bold text-lg" placeholder="M·∫≠t m√£ m·ªõi">
                    </div>
                    <button onclick="saveNewPassword()" class="bg-orange-600 text-white px-10 py-4 rounded-2xl font-black shadow-lg">L∆ØU M·∫¨T M√É</button>
                    <button onclick="closeChangePassModal()" class="text-gray-400 font-bold px-4 py-4">H·ª¶Y</button>
                </div>
            </div>
            <div class="flex-1 bg-white rounded-[3.5rem] overflow-hidden border-4 border-gray-50 shadow-inner">
                <div class="overflow-y-auto max-h-[60vh]">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="p-6 font-black text-gray-400 uppercase text-xs">H·ªçc sinh</th>
                                <th class="p-6 font-black text-gray-400 uppercase text-xs">N·ªôi dung</th>
                                <th class="p-6 font-black text-gray-400 uppercase text-xs text-center">K·∫øt qu·∫£</th>
                                <th class="p-6 font-black text-gray-400 uppercase text-xs">Ng√†y</th>
                            </tr>
                        </thead>
                        <tbody id="history-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- HELPER FUNCTIONS ---
        function numberToWords(n){
            const words={
                10:'m∆∞·ªùi',11:'m∆∞·ªùi m·ªôt',12:'m∆∞·ªùi hai',13:'m∆∞·ªùi ba',
                14:'m∆∞·ªùi b·ªën',15:'m∆∞·ªùi lƒÉm',16:'m∆∞·ªùi s√°u',
                17:'m∆∞·ªùi b·∫£y',18:'m∆∞·ªùi t√°m',19:'m∆∞·ªùi ch√≠n'
            };
            return words[n]||n;
        }

        function rInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function rArr(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

        const configs = [
            { group: "C√°c s·ªë ƒë·∫øn 20", count: 9, icon: "1Ô∏è‚É£" },
            { group: "Ph√©p t√≠nh 10+4, 14-4", count: 6, icon: "‚ûï" }, 
            { group: "Ph√©p t√≠nh 12+3, 15-3", count: 6, icon: "‚ûñ" }, 
            { group: "Chi·∫øc ƒë·ªìng h·ªì", count: 2, icon: "‚è∞" },
            { group: "Ch·ª•c, s·ªë tr√≤n ch·ª•c", count: 6, icon: "üì¶" },
            { group: "Ph√©p t√≠nh 30+20, 50-20", count: 6, icon: "üßÆ" }, 
            { group: "Ch·ª•c, ƒê∆°n v·ªã", count: 6, icon: "üî¢" },
            { group: "C√°c s·ªë ƒë·∫øn 40", count: 6, icon: "4Ô∏è‚É£0Ô∏è‚É£" },
            { group: "So s√°nh c√°c s·ªë", count: 6, icon: "‚öñÔ∏è" },
            { group: "C√°c s·ªë ƒë·∫øn 100", count: 9, icon: "üíØ" },
            { group: "B·∫£ng s·ªë 1-100", count: 6, icon: "üìÖ" },
            { group: "Ph√©p t√≠nh 34+23, 57-23", count: 8, icon: "üìù" }, 
            { group: "Ng√†y trong tu·∫ßn, T·ªù l·ªãch", count: 6, icon: "üìÜ" }, 
            { group: "Ki·ªÉm tra", count: 5, icon: "üö©", type: "exam" },
            { group: "ƒê·ªô d√†i, ƒêo ƒë·ªô d√†i", count: 6, icon: "üìè" }, 
            { group: "XƒÉng-ti-m√©t", count: 6, icon: "üìê" }, 
            { group: "KI·ªÇM TRA CU·ªêI NƒÇM", count: 8, icon: "üèÜ", type: "exam" }
        ];

        let lessons = [];
        let idCounter = 1;
        configs.forEach(cfg => {
            for(let i=1; i<=cfg.count; i++) {
                lessons.push({
                    id: idCounter++,
                    group: cfg.group,
                    title: `${cfg.group} - B√†i ${i}`,
                    icon: cfg.icon,
                    type: cfg.type || 'normal',
                    variant: i 
                });
            }
        });

        // H·ªÜ TH·ªêNG SINH 30 C√ÇU H·ªéI (20 C∆° b·∫£n + 10 N√¢ng cao)
        function generateQuestions(lesson) {
            let qs = [];
            for (let i = 1; i <= 30; i++) {
                let isAdvanced = i > 20;
                let qObj = null;
                let qType = rArr(['choice', 'fill', 'compare', 'sort']); 
                
                switch (lesson.group) {
                    case "C√°c s·ªë ƒë·∫øn 20":
                        let n = rInt(10, 19);
                        if (!isAdvanced) {
                            if (qType === 'choice') qObj = { type: 'choice', q: `S·ªë li·ªÅn sau c·ªßa ${n} l√†?`, options: [n+1, n-1, n+2, n], ans: n+1 };
                            else if (qType === 'fill') qObj = { type: 'fill', q: `S·ªë m∆∞·ªùi ${n===15?'lƒÉm':n-10} vi·∫øt l√†:`, ans: n };
                            else qObj = { type: 'compare', q: `So s√°nh: ${n} ... ${n+1}`, ans: '<' };
                        } else {
                            qObj = { type: 'sort', q: "S·∫Øp x·∫øp t·ª´ b√© ƒë·∫øn l·ªõn:", options: shuffle([n, n-2, n+3, n-5]), ans: [n-5, n-2, n, n+3] };
                        }
                        break;

                    case "Ph√©p t√≠nh 10+4, 14-4":
                        let u = rInt(1, 9);
                        if (!isAdvanced) {
                            if (i % 2 === 0) qObj = { type: 'fill', q: `10 + ${u} = ?`, ans: 10+u };
                            else qObj = { type: 'fill', q: `1${u} - ${u} = ?`, ans: 10 };
                        } else {
                            qObj = { type: 'compare', q: `So s√°nh: 10 + ${u} ... 1${u}`, ans: '=' };
                        }
                        break;

                    case "Chi·∫øc ƒë·ªìng h·ªì":
                        let h = rInt(1, 12);
                        if (!isAdvanced) {
                            qObj = { type: 'choice', q: `Kim ng·∫Øn ch·ªâ s·ªë ${h}, kim d√†i ch·ªâ s·ªë 12. L√† m·∫•y gi·ªù?`, options: [`${h} gi·ªù`, `${h+1} gi·ªù`, "12 gi·ªù", "6 gi·ªù"], ans: `${h} gi·ªù`, visual: "‚è∞" };
                        } else {
                            let hNext = (h + 2 > 12) ? h + 2 - 12 : h + 2;
                            qObj = { type: 'fill', q: `B√¢y gi·ªù l√† ${h} gi·ªù. 2 gi·ªù n·ªØa l√† m·∫•y gi·ªù?`, ans: hNext };
                        }
                        break;

                    case "Ch·ª•c, s·ªë tr√≤n ch·ª•c":
                        let tc = rInt(1, 9);
                        if (!isAdvanced) {
                            qObj = { type: 'fill', q: `${tc} ch·ª•c l√† bao nhi√™u?`, ans: tc*10 };
                        } else {
                            qObj = { type: 'sort', q: "S·∫Øp x·∫øp tƒÉng d·∫ßn:", options: shuffle([10, 50, 30, 90]), ans: [10, 30, 50, 90] };
                        }
                        break;

                    case "Ch·ª•c, ƒê∆°n v·ªã":
                        let num = rInt(11, 99);
                        let hc = Math.floor(num/10); let hd = num%10;
                        if (!isAdvanced) {
                            qObj = { type: 'choice', q: `S·ªë ${num} g·ªìm?`, options: [`${hc} ch·ª•c, ${hd} ƒë∆°n v·ªã`, `${hd} ch·ª•c, ${hc} ƒë∆°n v·ªã`, `${hc}0 ch·ª•c`, `${hd}0 ƒë∆°n v·ªã`], ans: `${hc} ch·ª•c, ${hd} ƒë∆°n v·ªã` };
                        } else {
                            qObj = { type: 'fill', q: `S·ªë g·ªìm ${hc} ch·ª•c v√† ${hd} ƒë∆°n v·ªã vi·∫øt l√†?`, ans: num };
                        }
                        break;

                    case "So s√°nh c√°c s·ªë":
                        if(!window.__cmpIdx){window.__cmpIdx=0;}
                        const cycle=['<','>','='];
                        let n1 = rInt(10, 99), n2 = rInt(10, 99);
                        const sign = cycle[window.__cmpIdx++ % 3];
                        const b = sign==='='?n1:(sign==='<'?n1+rInt(1,9):n1-rInt(1,9));
                        qObj = { type:'compare', q:`So s√°nh: ${n1} ... ${b}`, ans: sign };
                        break;

                    case "Ph√©p t√≠nh 34+23, 57-23":
                        let aa = rInt(1,5)*10 + rInt(1,5);
                        let bb = rInt(1,3)*10 + rInt(1,3);
                        if (i % 2 === 0) qObj = { type: 'fill', q: `${aa} + ${bb} = ?`, ans: aa+bb };
                        else qObj = { type: 'fill', q: `${aa+bb} - ${bb} = ?`, ans: aa };
                        break;

                    default:
                        let ra = rInt(1, 80), rb = rInt(1, 15);
                        qObj = { type: 'fill', q: `${ra} + ${rb} = ?`, ans: ra+rb };
                }
                if(!qObj.visual) qObj.visual = rArr(["üçé","üçä","üçá","üçâ","‚úàÔ∏è","üöó","üê∂","üê±","ü¶ä","üåü"]);
                qs.push(qObj);
            }
            
            const extraSorts = qs.filter(q=>q.type==='sort').slice(0,2);
            extraSorts.forEach(q=>{
                const desc=[...q.ans].sort((a,b)=>b-a);
                qs.push({
                    type:'sort',
                    q:'S·∫Øp x·∫øp t·ª´ l·ªõn ƒë·∫øn b√©:',
                    options: shuffle([...q.ans]),
                    ans: desc,
                    visual: q.visual
                });
            });
            return qs;
    
        }

        let state = {
            user: null,
            currentLesson: null,
            questions: [],
            qIndex: 0,
            score: 0,
            history: JSON.parse(localStorage.getItem('math_pro_db_v4')) || [],
            teacherPass: localStorage.getItem('teacher_pass_secure') || '123456',
            viewState: 'topics',
            currentGroup: null
        };

        function switchView(id) {
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden-view'));
            document.getElementById(id).classList.remove('hidden-view');
            const info = document.getElementById('user-info');
            if (state.user && !['view-landing', 'view-student-login', 'view-teacher-login'].includes(id)) {
                info.classList.remove('hidden');
                document.getElementById('display-name').textContent = state.user.name;
            } else info.classList.add('hidden');
        }

        function studentLogin() {
            const name = document.getElementById('student-name').value.trim();
            const cls = document.getElementById('student-class').value.trim();
            if (!name || !cls) { alert("B√© h√£y nh·∫≠p ƒë·ªß t√™n v√† l·ªõp nh√©!"); return; }
            state.user = { name: `${name} (${cls})`, role: 'student' };
            state.viewState = 'topics';
            renderLessons();
            switchView('view-lesson-select');
        }

        function teacherLogin() {
            if (document.getElementById('teacher-pass').value === state.teacherPass) {
                state.user = { name: "Gi√°o vi√™n", role: 'teacher' };
                renderHistory();
                switchView('view-teacher-dashboard');
            } else alert("M·∫≠t m√£ ch∆∞a ƒë√∫ng r·ªìi!");
        }

        function renderLessons() {
            const grid = document.getElementById('lesson-grid');
            const title = document.getElementById('menu-title');
            const subtitle = document.getElementById('menu-subtitle');
            grid.innerHTML = '';

            if (state.viewState === 'topics') {
                title.textContent = "CH·ªåN CH·ª¶ ƒê·ªÄ";
                subtitle.textContent = "H·ªçc k·ª≥ II";
                configs.forEach(cfg => {
                    const card = document.createElement('div');
                    let colorClass = cfg.type === 'exam' ? 'border-red-400 bg-red-50 hover:border-red-500' : 'border-blue-200 bg-white hover:border-blue-400';
                    card.className = `p-6 rounded-[2.5rem] shadow-lg border-b-[6px] cursor-pointer hover:scale-105 transition-all flex flex-col items-center text-center ${colorClass} group`;
                    card.innerHTML = `<div class="w-20 h-20 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center text-4xl mb-4 group-hover:scale-110 transition-transform">${cfg.icon}</div>
                        <h4 class="font-black text-lg text-gray-800 mb-2">${cfg.group}</h4>
                        <span class="text-[10px] font-bold uppercase text-white bg-blue-400 px-3 py-1 rounded-full">${cfg.count} B√†i</span>`;
                    card.onclick = () => { state.viewState = 'lessons'; state.currentGroup = cfg.group; renderLessons(); };
                    grid.appendChild(card);
                });
            } else {
                title.textContent = state.currentGroup;
                subtitle.innerHTML = `<button onclick="backToTopics()" class="text-blue-500 font-black hover:underline bg-white px-4 py-2 rounded-xl">‚óÄ Quay l·∫°i</button>`;
                lessons.filter(l => l.group === state.currentGroup).forEach(l => {
                    const card = document.createElement('div');
                    card.className = `p-4 rounded-[2rem] shadow-md border-b-[4px] cursor-pointer hover:scale-105 transition-all flex flex-col items-center text-center border-green-200 bg-white hover:border-green-400`;
                    card.innerHTML = `<div class="text-3xl mb-2">${l.icon}</div><h4 class="font-black text-sm text-gray-700">B√†i ${l.variant}</h4>`;
                    card.onclick = () => startLesson(l);
                    grid.appendChild(card);
                });
            }
        }

        function backToTopics() { state.viewState = 'topics'; renderLessons(); }

        function startLesson(lesson) {
            state.currentLesson = lesson;
            state.questions = generateQuestions(lesson);
            state.qIndex = 0;
            state.score = 0;
            switchView('view-game');
            showQuestion();
        }

        function showQuestion() {
            const q = state.questions[state.qIndex];
            const isAdvanced = state.qIndex >= 20;
            
            document.getElementById('progress-bar').style.width = `${((state.qIndex) / 30) * 100}%`;
            document.getElementById('question-counter').textContent = `C√¢u ${state.qIndex + 1}/30`;
            const tag = document.getElementById('difficulty-tag');
            tag.textContent = isAdvanced ? "N√¢ng cao" : "C∆° b·∫£n";
            tag.className = `text-[9px] font-black uppercase px-2 py-0.5 rounded-full ${isAdvanced ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'}`;

            document.getElementById('question-text').textContent = q.q;
            const visual = document.getElementById('visual-aid');
            visual.innerHTML = '';
            if (q.visual && typeof q.visual === 'string' && isAdvanced === false) {
                for(let i=0; i<5; i++) visual.innerHTML += `<span>${q.visual}</span>`;
            }

            // Reset areas
            ['options-grid', 'fill-input-area', 'compare-area', 'sort-area', 'feedback-area'].forEach(id => document.getElementById(id).classList.add('hidden-view'));
            
            if (q.type === 'choice') {
                const grid = document.getElementById('options-grid');
                grid.classList.remove('hidden-view');
                grid.innerHTML = '';
                q.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "btn-game bg-white p-6 rounded-3xl text-xl font-black border-4 border-blue-50 shadow-md hover:border-blue-300";
                    btn.textContent = opt;
                    btn.onclick = () => checkAnswer(opt);
                    grid.appendChild(btn);
                });
            } else if (q.type === 'fill') {
                document.getElementById('fill-input-area').classList.remove('hidden-view');
                document.getElementById('ans-input').value = '';
                document.getElementById('ans-input').focus();
            } else if (q.type === 'compare') {
                document.getElementById('compare-area').classList.remove('hidden-view');
            } else if (q.type === 'sort') {
                document.getElementById('sort-area').classList.remove('hidden-view');
                const pool = document.getElementById('sort-pool');
                const target = document.getElementById('sort-target');
                pool.innerHTML = ''; target.innerHTML = '';
                q.options.forEach(opt => {
                    const item = document.createElement('div');
                    item.className = "drag-item bg-white px-6 py-3 rounded-2xl font-black shadow-md border-2 border-blue-100 text-blue-600";
                    item.textContent = opt;
                    item.onclick = () => {
                        if (item.parentElement === pool) target.appendChild(item);
                        else pool.appendChild(item);
                    };
                    pool.appendChild(item);
                });
            }
        }

        function checkAnswer(userAns) {
            const q = state.questions[state.qIndex];
            const isCorrect = String(userAns) === String(q.ans);
            if (isCorrect) state.score += (state.qIndex >= 20 ? 4 : 3); // N√¢ng cao ƒëi·ªÉm cao h∆°n

            const feedback = document.getElementById('feedback-area');
            const msg = document.getElementById('feedback-msg');
            feedback.classList.remove('hidden-view');
            msg.textContent = isCorrect ? "CH√çNH X√ÅC! üåü" : `CH∆ØA ƒê√öNG! (ƒê√°p √°n: ${q.ans})`;
            msg.className = `text-3xl font-black tracking-tighter ${isCorrect ? 'text-green-500 animate__bounce' : 'text-red-400'}`;
            
            document.getElementById('next-btn').onclick = () => {
                state.qIndex++;
                if (state.qIndex < 30) showQuestion();
                else endLevel();
            };
        }

        function submitFillAnswer() { checkAnswer(document.getElementById('ans-input').value); }
        function checkCompare(op) { checkAnswer(op); }
        function submitSortAnswer() {
            const items = Array.from(
                document.getElementById('sort-target').children
            ).map(i => Number(i.textContent.trim()));

            const correct = state.questions[state.qIndex].ans;
            const isCorrect = items.length === correct.length &&
                              items.every((v,i)=>v===correct[i]);

            checkAnswer(isCorrect ? correct.join(',') : "Sai");
        }

        function endLevel() {
            const maxScore = (20 * 3) + (10 * 4); // 100 ƒëi·ªÉm
            const percent = (state.score / maxScore) * 10;
            const final = Math.min(10, Math.round(percent * 10) / 10);
            
            switchView('view-result');
            document.getElementById('final-score').textContent = final;
            
            const emoji = document.getElementById('result-emoji');
            const title = document.getElementById('result-title');
            if (final >= 9) { emoji.textContent = "üèÜ"; title.textContent = "XU·∫§T S·∫ÆC QU√Å!"; triggerConfetti(100); }
            else if (final >= 7) { emoji.textContent = "üåü"; title.textContent = "GI·ªéI L·∫ÆM!"; }
            else { emoji.textContent = "üí™"; title.textContent = "C·ªê G·∫ÆNG H∆†N NH√â!"; }

            state.history.push({
                user: state.user.name,
                lesson: state.currentLesson.title,
                score: final,
                date: new Date().toLocaleString('vi-VN')
            });
            localStorage.setItem('math_pro_db_v4', JSON.stringify(state.history));
        }

        function renderHistory() {
            const body = document.getElementById('history-body');
            body.innerHTML = state.history.reverse().map(h => `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                    <td class="p-6 font-bold text-gray-700">${h.user}</td>
                    <td class="p-6 text-gray-500 font-medium">${h.lesson}</td>
                    <td class="p-6 text-center"><span class="px-4 py-1 rounded-full font-black ${h.score >= 8 ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}">${h.score}</span></td>
                    <td class="p-6 text-xs text-gray-400 font-bold">${h.date}</td>
                </tr>
            `).join('');
        }

        function exportData() {
            let csv = "H·ªçc sinh,B√†i h·ªçc,ƒêi·ªÉm,Ng√†y\n";
            state.history.forEach(h => csv += `${h.user},${h.lesson},${h.score},${h.date}\n`);
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "ket_qua_hoc_tap.csv";
            link.click();
        }

        function goHome() { 
            if(state.user?.role === 'teacher') switchView('view-teacher-dashboard');
            else if(state.user) {
                state.viewState = 'topics';
                renderLessons();
                switchView('view-lesson-select');
            }
            else switchView('view-landing'); 
        }
        function logout() { state.user = null; switchView('view-landing'); }
        function confirmExit() { if(confirm("B√© mu·ªën d·ª´ng b√†i h·ªçc n√†y kh√¥ng?")) goHome(); }

        // M·∫≠t m√£ gi√°o vi√™n
        function openChangePassModal() { document.getElementById('change-pass-section').classList.remove('hidden'); }
        function closeChangePassModal() { document.getElementById('change-pass-section').classList.add('hidden'); }
        function saveNewPassword() {
            const p = document.getElementById('new-teacher-pass').value;
            if(p.length < 4) return alert("M·∫≠t m√£ c·∫ßn √≠t nh·∫•t 4 k√Ω t·ª±");
            state.teacherPass = p;
            localStorage.setItem('teacher_pass_secure', p);
            alert("ƒê√£ ƒë·ªïi m·∫≠t m√£ th√†nh c√¥ng!");
            closeChangePassModal();
        }

        // CONFETTI EFFECT
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function triggerConfetti(num) {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            for(let i=0; i<num; i++) particles.push({ x: canvas.width/2, y: canvas.height/2, vx: (Math.random()-0.5)*25, vy: (Math.random()-1.2)*25, c: `hsl(${Math.random()*360}, 80%, 60%)`, s: Math.random()*10+5, l: 100 });
            animConfetti();
        }
        function animConfetti() {
            if(!particles.length) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.vy += 0.6; p.l--;
                ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                if(p.l <= 0) particles.splice(i, 1);
            });
            requestAnimationFrame(animConfetti);
        }

        /* ===== AUDIO LOGIC (FIXED) ===== */
        let isAudioUnlocked = false;
        
        // H√†m m·ªü kh√≥a √¢m thanh khi ng∆∞·ªùi d√πng t∆∞∆°ng t√°c l·∫ßn ƒë·∫ßu
        function unlockAudio() {
            if (isAudioUnlocked) return;
            
            const bgMusic = document.getElementById('bg-music');
            if (bgMusic) {
                bgMusic.volume = 0.3; // √Çm l∆∞·ª£ng 30%
                bgMusic.play().then(() => {
                    isAudioUnlocked = true;
                    // H·ªßy l·∫Øng nghe s·ª± ki·ªán sau khi ƒë√£ m·ªü kh√≥a
                    document.removeEventListener('click', unlockAudio);
                    document.removeEventListener('touchstart', unlockAudio);
                    document.removeEventListener('keydown', unlockAudio);
                }).catch(e => {
                    console.log("Tr√¨nh duy·ªát ch·∫∑n autoplay, ch·ªù t∆∞∆°ng t√°c...");
                });
            }
        }

        // H√†m ph√°t ti·∫øng click (reset th·ªùi gian ƒë·ªÉ ph√°t nhanh li√™n t·ª•c)
        function playClickSound() {
            const sfx = document.getElementById('sfx-click');
            if (sfx) {
                sfx.currentTime = 0; // Tua v·ªÅ ƒë·∫ßu
                sfx.volume = 0.6;
                sfx.play().catch(e => {});
            }
        }

        // L·∫Øng nghe s·ª± ki·ªán "ch·∫°m" ƒë·∫ßu ti√™n ƒë·ªÉ m·ªü kh√≥a nh·∫°c n·ªÅn
        document.addEventListener('click', unlockAudio);
        document.addEventListener('touchstart', unlockAudio);
        document.addEventListener('keydown', unlockAudio);

        // L·∫Øng nghe click ƒë·ªÉ ph√°t ti·∫øng "Pop"
        document.addEventListener('click', (e) => {
            const target = e.target.closest('button, input, .cursor-pointer, .drag-item');
            if (target) {
                playClickSound();
            }
        });

    </script>

<!-- ===== KHO B√ÅU STICKER ===== -->
<button id="treasureBtn" style="position:fixed;top:15px;right:15px;font-size:22px;border:none;border-radius:50%;padding:10px 14px;cursor:pointer;background:#ffd700;">üèÜ</button>

<div id="treasurePanel" style="display:none;position:fixed;top:70px;right:20px;background:#fff;border-radius:12px;padding:12px 16px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:999;">
  <h3 style="margin-top:0;">üèÜ Kho b√°u Sticker</h3>
  <div style="display:flex;gap:10px;font-size:36px;">
    <div id="stickerGold" class="sticker dim">ü•á</div>
    <div id="stickerStar" class="sticker dim">‚≠ê</div>
    <div id="stickerMedal" class="sticker dim">üèÖ</div>
  </div>
</div>

<style>
.sticker.dim { opacity: 0.3; filter: grayscale(1); }
.sticker.bright { opacity: 1; filter: none; animation: bounceIn 0.8s; }
@keyframes bounceIn {
  0% { transform: scale(0.3); opacity: 0; }
  50% { transform: scale(1.1); }
  70% { transform: scale(0.9); }
  100% { transform: scale(1); opacity: 1; }
}
</style>


<!-- ===== CH·∫æ ƒê·ªò 2 B·∫†N ===== -->
<button id="twoPlayerBtn" style="position:fixed;top:15px;right:70px;font-size:20px;border:none;border-radius:50%;padding:10px 12px;cursor:pointer;background:#4caf50;color:#fff;">üë´</button>

<div id="twoPlayerPanel" style="display:none;position:fixed;top:70px;right:90px;background:#fff;border-radius:12px;padding:12px 16px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:999;">
  <h3 style="margin-top:0;">üë´ Ch·∫ø ƒë·ªô thi ƒë·∫•u</h3>
  <p><strong>B·∫°n A</strong>: <span id="scoreA">0</span> ƒëi·ªÉm</p>
  <p><strong>B·∫°n B</strong>: <span id="scoreB">0</span> ƒëi·ªÉm</p>
  <p><em>ƒê·∫øn l∆∞·ª£t:</em> <span id="currentTurn">A</span></p>
</div>


<!-- ===== EXTENSION SCRIPT (NON-DESTRUCTIVE ADDITION) ===== -->
<script>
/* ===============================
   EXTENSION LAYER - SAFE ADDON
   Kh√¥ng thay ƒë·ªïi logic g·ªëc
================================ */

// ---- TIME MODE ----
if(typeof state !== "undefined"){
    state.timeMode = false;
    state.timeLeft = 120;
    state.timerInterval = null;
}

// Add timer UI next to progress bar if exists
window.addEventListener("load", ()=>{
    const barArea = document.querySelector("#view-game .flex.items-center");
    if(barArea && !document.getElementById("timer-label")){
        const timer = document.createElement("div");
        timer.id = "timer-label";
        timer.className = "font-black text-red-500 text-sm ml-3";
        timer.textContent = "";
        barArea.appendChild(timer);
    }
});

function startTimeMode(){
    state.timeMode = true;
    state.timeLeft = 120;
    updateTimer();
}

function updateTimer(){
    if(!state.timeMode) return;
    const el = document.getElementById("timer-label");
    if(el) el.textContent = "‚è± " + state.timeLeft + "s";

    if(state.timeLeft <= 0){
        state.timeMode = false;
        if(typeof endLevel === "function") endLevel();
        return;
    }
    state.timeLeft--;
    state.timerInterval = setTimeout(updateTimer,1000);
}


// ---- AVATAR SUPPORT (NON BREAKING) ----
if(typeof state !== "undefined"){
    if(!state.userAvatar) state.userAvatar = "üë¶";
}

// ---- SIMPLE LEADERBOARD VIEW (USING EXISTING HISTORY) ----
function showLeaderboard(){
    if(!state.history) return;
    const summary = {};
    state.history.forEach(h=>{
        if(!summary[h.user]) summary[h.user]=0;
        summary[h.user]+=Number(h.score||0);
    });
    alert("B·∫£ng x·∫øp h·∫°ng l·ªõp:\n\n" +
        Object.entries(summary)
        .sort((a,b)=>b[1]-a[1])
        .map((v,i)=> (i+1)+". "+v[0]+" - "+v[1]+" ƒëi·ªÉm")
        .join("\n")
    );
}
</script>
<!-- ===== EXTENSION V2 : COMPARE + AI EXAM IN TEACHER DASHBOARD ===== -->
<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz39VDo_g32AVen0rBFUG73WRP856RaSaSyiNpxN4Ains79W2kzetb7FSDEZVrRa6KV/exec";

let answerKey = [];
/* =====================================================
   EXTENSION V2 - SAFE PATCH
   Kh√¥ng s·ª≠a logic c≈©, ch·ªâ m·ªü r·ªông
===================================================== */

// ===== 1. B·ªî SUNG D·∫†NG SO S√ÅNH < = > =====
// Ghi ƒë√® generateQuestions theo ki·ªÉu wrapper (kh√¥ng ph√° h√†m g·ªëc)
if(typeof generateQuestions === "function"){
    const oldGenerateQuestions = generateQuestions;
    window.generateQuestions = function(lesson){
        const qs = oldGenerateQuestions(lesson);

        // ƒë·∫£m b·∫£o c√≥ c√¢u "=" xu·∫•t hi·ªán trong nh√≥m so s√°nh
        qs.forEach(q=>{
            if(q.type === "compare"){
                // 30% t·∫°o tr∆∞·ªùng h·ª£p b·∫±ng nhau
                if(Math.random() < 0.3){
                    const nums = q.q.match(/\d+/g);
                    if(nums && nums.length >= 1){
                        const n = nums[0];
                        q.q = `So s√°nh: ${n} ... ${n}`;
                        q.ans = "=";
                    }
                }
            }
        });
        
            const extraSorts = qs.filter(q=>q.type==='sort').slice(0,2);
            extraSorts.forEach(q=>{
                const desc=[...q.ans].sort((a,b)=>b-a);
                qs.push({
                    type:'sort',
                    q:'S·∫Øp x·∫øp t·ª´ l·ªõn ƒë·∫øn b√©:',
                    options: shuffle([...q.ans]),
                    ans: desc,
                    visual: q.visual
                });
            });
            return qs;
    
    }
}


// ===== 2. TH√äM MENU AI SINH ƒê·ªÄ TRONG TEACHER DASHBOARD =====
window.addEventListener("load", ()=>{

    const teacherHeader = document.querySelector("#view-teacher-dashboard .flex.justify-between");
    if(!teacherHeader) return;

    if(!document.getElementById("btn-ai-exam")){
        const btn = document.createElement("button");
        btn.id = "btn-ai-exam";
        btn.textContent = "T·∫†O ƒê·ªÄ KI·ªÇM TRA AI";
        btn.className = "bg-blue-500 text-white px-6 py-2 rounded-2xl text-sm font-black shadow-sm";
        btn.onclick = openAIExamPanel;
        teacherHeader.querySelector(".flex.gap-3").appendChild(btn);
    }
});

function openAIExamPanel(){
    if(document.getElementById("ai-exam-panel")) return;

    const container = document.createElement("div");
    container.id = "ai-exam-panel";
    container.className = "mb-8 bg-blue-50 p-8 rounded-[3rem] border-4 border-blue-100";

    container.innerHTML = `
        <h3 class="font-black text-blue-600 mb-6 uppercase text-sm">
            AI Sinh ƒë·ªÅ HKII (Ma tr·∫≠n CTST - 15 TN + 8 TL)
        </h3>

        <button onclick="generateAIExam()"
            class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black shadow-lg hover:bg-blue-700 transition-colors">
            SINH ƒê·ªÄ M·ªöI üé≤
        </button>

        <button onclick="exportAIExamWord()"
            class="bg-green-500 text-white px-6 py-3 rounded-2xl font-black shadow-lg ml-3 hover:bg-green-600 transition-colors">
            XU·∫§T WORD üìÑ
        </button>
	<button onclick="submitExam()"
    	   class="bg-purple-500 text-white px-6 py-3 rounded-2xl font-black shadow-lg ml-3 hover:bg-purple-600 transition-colors">
    	N·ªòP B√ÄI ONLINE üöÄ
	</button>
        <pre id="ai-exam-output"
            style="white-space:pre-wrap;margin-top:16px;background:#fff;padding:16px;border-radius:16px;border:2px solid #e2e8f0;font-family:'Times New Roman', Times, serif;font-size:16px;line-height:1.5;max-height:400px;overflow-y:auto;"></pre>
    `;

    const dash = document.getElementById("view-teacher-dashboard");
    dash.insertBefore(container, dash.children[1]);
}

// ===== 3. AI SINH ƒê·ªÄ THEO C·∫§U TR√öC M·ªöI (15 TR·∫ÆC NGHI·ªÜM + 8 T·ª∞ LU·∫¨N) =====
function r(min,max){
    return Math.floor(Math.random()*(max-min+1))+min;
}

function generateAIExam(){
    answerKey = [];
    let text = `ƒê·ªÄ KI·ªÇM TRA H·ªåC K·ª≤ II - NƒÇM H·ªåC 2024-2025
M√îN TO√ÅN L·ªöP 1 ‚Äì CH√ÇN TR·ªúI S√ÅNG T·∫†O
Th·ªùi gian l√†m b√†i: 40 ph√∫t

PH·∫¶N I. TR·∫ÆC NGHI·ªÜM (15 c√¢u)
Khoanh tr√≤n v√†o ch·ªØ c√°i tr∆∞·ªõc c√¢u tr·∫£ l·ªùi ƒë√∫ng.

`;

    // --- 15 C√ÇU TR·∫ÆC NGHI·ªÜM ---
    
    // C√¢u 1: S·ªë li·ªÅn sau/tr∆∞·ªõc (Nh·∫≠n bi·∫øt)
    let n1 = r(20, 89);
	answerKey.push("B");
    text += `C√¢u 1. S·ªë li·ªÅn sau c·ªßa ${n1} l√†:\n   A. ${n1-1}     B. ${n1+1}     C. ${n1+2}     D. ${n1}\n\n`;

    // C√¢u 2: C·∫•u t·∫°o s·ªë (Nh·∫≠n bi·∫øt)
    let chuc = r(2, 9);
	answerKey.push("C");
    text += `C√¢u 2. ${chuc} ch·ª•c c√≤n g·ªçi l√†:\n   A. ${chuc}00     B. ${chuc}     C. ${chuc*10}     D. 1${chuc}\n\n`;

    // C√¢u 3: G·ªìm ch·ª•c v√† ƒë∆°n v·ªã (Nh·∫≠n bi·∫øt)
    let c = r(3, 8), d = r(1, 9);
	answerKey.push("A");
    text += `C√¢u 3. S·ªë g·ªìm ${c} ch·ª•c v√† ${d} ƒë∆°n v·ªã vi·∫øt l√†:\n   A. ${c}${d}     B. ${d}${c}     C. ${c+d}     D. ${c}0${d}\n\n`;

    // C√¢u 4: Ph√©p c·ªông tr√≤n ch·ª•c (Th√¥ng hi·ªÉu)
    let a4 = r(2,5)*10, b4 = r(1,3)*10;
	answerKey.push("B");
    text += `C√¢u 4. K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh ${a4} + ${b4} l√†:\n   A. ${a4+b4+10}     B. ${a4+b4}     C. ${(a4+b4)/10}     D. ${Math.abs(a4-b4)}\n\n`;

    // C√¢u 5: Ph√©p tr·ª´ trong ph·∫°m vi 100 (Th√¥ng hi·ªÉu)
    let a5 = r(40,80), b5 = r(10,30);
	answerKey.push("A");
    text += `C√¢u 5. K·∫øt qu·∫£ c·ªßa ph√©p t√≠nh ${a5} - ${b5} l√†:\n   A. ${a5-b5}     B. ${a5+b5}     C. ${a5-b5-1}     D. ${a5-b5+10}\n\n`;

    // C√¢u 6: So s√°nh (Th√¥ng hi·ªÉu)
    let n6 = r(30, 80);
	answerKey.push("C");
    text += `C√¢u 6. ƒêi·ªÅn d·∫•u th√≠ch h·ª£p: ${n6} ..... ${n6}:\n   A. >     B. <     C. =     D. Kh√°c\n\n`;

    // C√¢u 7: S·ªë l·ªõn nh·∫•t (Th√¥ng hi·ªÉu)
    let arr7 = [r(10,30), r(40,60), r(70,90), r(91,99)].sort(()=>Math.random()-0.5);
    let max7 = Math.max(...arr7);
	answerKey.push("D");
    text += `C√¢u 7. S·ªë l·ªõn nh·∫•t trong c√°c s·ªë ${arr7.join(", ")} l√†:\n   A. ${arr7[0]}     B. ${arr7[1]}     C. ${arr7[2]}     D. ${max7}\n\n`;

    // C√¢u 8: H√¨nh h·ªçc (Nh·∫≠n bi·∫øt)
    text += `C√¢u 8. H√¨nh vu√¥ng c√≥ m·∫•y c·∫°nh b·∫±ng nhau?\n   A. 2     B. 3     C. 4     D. 5\n\n`;
answerKey.push("C");

    // C√¢u 9: ƒê·ªìng h·ªì (V·∫≠n d·ª•ng th·∫•p)
    let h9 = r(1, 11);
    text += `C√¢u 9. Kim ng·∫Øn ch·ªâ s·ªë ${h9}, kim d√†i ch·ªâ s·ªë 12. L√∫c ƒë√≥ l√† m·∫•y gi·ªù?\n   A. 12 gi·ªù     B. ${h9} gi·ªù     C. 6 gi·ªù     D. ${h9+1} gi·ªù\n\n`;
	answerKey.push("B");

    // C√¢u 10: Ng√†y trong tu·∫ßn (V·∫≠n d·ª•ng th·∫•p)
    let days = ["Th·ª© Hai", "Th·ª© Ba", "Th·ª© T∆∞", "Th·ª© NƒÉm", "Th·ª© S√°u", "Th·ª© B·∫£y", "Ch·ªß Nh·∫≠t"];
    let idx = r(0, 4);
	answerKey.push("A");
    text += `C√¢u 10. H√¥m nay l√† ${days[idx]}, ng√†y mai l√†:\n   A. ${days[idx+1]}     B. ${days[idx+2]}     C. ${days[idx-1]||"Ch·ªß Nh·∫≠t"}     D. Th·ª© B·∫£y\n\n`;

    // C√¢u 11: ƒêo ƒë·ªô d√†i (V·∫≠n d·ª•ng th·∫•p)
    let len = r(10, 20);
	answerKey.push("A");
    text += `C√¢u 11. M·ªôt gang tay c·ªßa em d√†i kho·∫£ng:\n   A. ${len} cm     B. ${len} km     C. ${len} gang tay     D. 1 b∆∞·ªõc ch√¢n\n\n`;

    // C√¢u 12: T√≠nh to√°n 3 s·ªë (V·∫≠n d·ª•ng th·∫•p)
    let n12 = r(5,10), n12b = r(2,5), n12c = r(1,4);
    let res12 = n12 + n12b - n12c;
	answerKey.push("A");
    text += `C√¢u 12. ${n12} + ${n12b} - ${n12c} = ?\n   A. ${res12}     B. ${res12+2}     C. ${res12-1}     D. ${res12+5}\n\n`;

    // C√¢u 13: T√¨m s·ªë (Th√¥ng hi·ªÉu)
    let target = r(50, 60);
	answerKey.push("A");
    text += `C√¢u 13. S·ªë tr√≤n ch·ª•c li·ªÅn tr∆∞·ªõc s·ªë ${target} l√†:\n   A. ${Math.floor((target-10)/10)*10}     B. 50     C. 60     D. 40\n\n`;

    // C√¢u 14: Logic (Th√¥ng hi·ªÉu)
    text += `C√¢u 14. G·ªôp 30 v√† 20 ƒë∆∞·ª£c bao nhi√™u?\n   A. 10     B. 50     C. 3020     D. 60\n\n`;
	answerKey.push("B");

    // C√¢u 15: T∆∞ duy (V·∫≠n d·ª•ng cao)
    text += `C√¢u 15. Lan c√≥ 10 c√°i k·∫πo, Lan ƒÉn h·∫øt 2 c√°i. Lan c√≤n l·∫°i:\n   A. 12 c√°i     B. 8 c√°i     C. 10 c√°i     D. 0 c√°i\n\n`;
	answerKey.push("B");

    // --- 8 C√ÇU T·ª∞ LU·∫¨N (ƒê√£ s·ª≠a l·ªói hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß) ---
    text += `PH·∫¶N II. T·ª∞ LU·∫¨N (8 c√¢u)\n\n`;

    // C√¢u 16: ƒê·∫∑t t√≠nh r·ªìi t√≠nh (Nh·∫≠n bi·∫øt)
    let a16 = r(20,50), b16 = r(10,40);
    let a17 = r(60,90), b17 = r(10,50);
    text += `C√¢u 16. ƒê·∫∑t t√≠nh r·ªìi t√≠nh:\n`;
    text += `   ${a16} + ${b16}            ${a17} - ${b17}\n   ............            ............\n   ............            ............\n   ............            ............\n\n`;

    // C√¢u 17: T√≠nh nh·∫©m (Nh·∫≠n bi·∫øt)
    text += `C√¢u 17. T√≠nh nh·∫©m:\n`;
    text += `   ${r(10,40)} + ${r(5,9)} = .....       ${r(50,80)} - ${r(10,30)} = .....\n   ${r(20,60)} + 10 = .....       ${r(30,50)} - 20 = .....\n\n`;

    // C√¢u 18: ƒêi·ªÅn d·∫•u (Th√¥ng hi·ªÉu)
    let d1 = r(20,80), d2 = r(20,80);
    text += `C√¢u 18. ƒêi·ªÅn d·∫•u ( >, <, = ) v√†o ch·ªó ch·∫•m:\n`;
    text += `   ${d1} ....... ${d2}               ${r(10,30)} + ${r(10,20)} ....... ${r(50,90)}\n\n`;

    // C√¢u 19: S·∫Øp x·∫øp (Th√¥ng hi·ªÉu)
    let arr19 = [r(10,99), r(10,99), r(10,99), r(10,99)];
    text += `C√¢u 19. Cho c√°c s·ªë: ${arr19.join("; ")}\n`;
    text += `   - Vi·∫øt theo th·ª© t·ª± t·ª´ b√© ƒë·∫øn l·ªõn: ...........................................\n`;
    text += `   - Vi·∫øt theo th·ª© t·ª± t·ª´ l·ªõn ƒë·∫øn b√©: ...........................................\n\n`;

    // C√¢u 20: Vi·∫øt s·ªë (Nh·∫≠n bi·∫øt)
    text += `C√¢u 20. Vi·∫øt s·ªë th√≠ch h·ª£p v√†o ch·ªó ch·∫•m:\n`;
    text += `   - Ba m∆∞∆°i lƒÉm: ...........      - B·∫£y m∆∞∆°i m·ªët: ...........\n`;
    text += `   - S·ªë li·ªÅn sau c·ªßa 99 l√†: ........... \n\n`;

    // C√¢u 21: V·∫Ω ƒëo·∫°n th·∫≥ng (V·∫≠n d·ª•ng)
    let cm = r(5, 10);
    text += `C√¢u 21. Em h√£y v·∫Ω m·ªôt ƒëo·∫°n th·∫≥ng d√†i ${cm} cm v√† ƒë·∫∑t t√™n l√† AB.\n\n\n\n`;

    // C√¢u 22: Gi·∫£i to√°n - Ph√©p c·ªông (V·∫≠n d·ª•ng)
    let ga = r(20,40), vit = r(10,30);
    text += `C√¢u 22. Nh√† b√† c√≥ ${ga} con g√† v√† ${vit} con v·ªãt. H·ªèi nh√† b√† c√≥ t·∫•t c·∫£ bao nhi√™u con g√† v√† v·ªãt?\n`;
    text += `   B√†i gi·∫£i:\n   ..........................................................................\n   ..........................................................................\n   ..........................................................................\n\n`;

    // C√¢u 23: Gi·∫£i to√°n - Ph√©p tr·ª´ (V·∫≠n d·ª•ng cao)
    let keo = r(30,50), cho = r(10,20);
    text += `C√¢u 23. M·∫π mua ${keo} qu·∫£ t√°o, m·∫π bi·∫øu b√† ${cho} qu·∫£. H·ªèi m·∫π c√≤n l·∫°i bao nhi√™u qu·∫£ t√°o?\n`;
    text += `   B√†i gi·∫£i:\n   ..........................................................................\n   ..........................................................................\n   ..........................................................................\n`;

    text += `\n------------------ H·∫æT ------------------`;

    // C·∫≠p nh·∫≠t n·ªôi dung v√†o khung hi·ªÉn th·ªã
    document.getElementById("ai-exam-output").textContent = text;
}
    async function exportAIExamWord() {
    // 1. Ki·ªÉm tra th∆∞ vi·ªán ƒë√£ t·∫£i xong ch∆∞a
    if (typeof docx === 'undefined') {
        alert("L·ªói: Th∆∞ vi·ªán docx ch∆∞a ƒë∆∞·ª£c t·∫£i! \n\nB·∫°n h√£y ki·ªÉm tra:\n1. M√°y t√≠nh c√≥ ƒëang k·∫øt n·ªëi Internet kh√¥ng?\n2. ƒê√£ thay link unpkg ·ªü ƒë·∫ßu file ch∆∞a?");
        return;
    }

    const outputElement = document.getElementById("ai-exam-output");
    const content = outputElement ? outputElement.innerText : "";
    
    if (!content || content.trim() === "" || content.includes("ƒêang chu·∫©n b·ªã")) {
        alert("B√© ∆°i, h√£y nh·∫•n 'SINH ƒê·ªÄ M·ªöI' v√† ƒë·ª£i m√°y hi·ªán ƒë·ªÅ b√†i xong ƒë√£ nh√©!");
        return;
    }

    try {
        // L·∫•y c√°c th√†nh ph·∫ßn t·ª´ th∆∞ vi·ªán docx (D√πng window.docx ƒë·ªÉ ch·∫Øc ch·∫Øn)
        const { Document, Packer, Paragraph, TextRun, AlignmentType } = window.docx;

        const lines = content.split("\n").filter(line => line.trim() !== "");
        const docChildren = [];

        lines.forEach((line, index) => {
            const isTitle = index === 0;
            docChildren.push(
                new Paragraph({
                    children: [
                        new TextRun({
                            text: line,
                            bold: isTitle,
                            size: isTitle ? 32 : 26,
                            font: "Arial" // ƒê·∫£m b·∫£o font ch·ªØ ph·ªï bi·∫øn
                        }),
                    ],
                    alignment: isTitle ? AlignmentType.CENTER : AlignmentType.LEFT,
                    spacing: { before: 120, after: 120 },
                })
            );
        });

        const doc = new Document({
            sections: [{
                properties: {},
                children: docChildren,
            }],
        });

        // T·∫°o v√† t·∫£i file
        const blob = await Packer.toBlob(doc);
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        link.href = url;
        link.download = "De_Toan_Lop_1.docx";
        document.body.appendChild(link);
        link.click();
        
        // D·ªçn d·∫πp b·ªô nh·ªõ
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 100);

    } catch (error) {
        console.error("Chi ti·∫øt l·ªói:", error);
        alert("C√≥ l·ªói k·ªπ thu·∫≠t: " + error.message);
    }
}
function submitExam(){

    const name = prompt("Nh·∫≠p h·ªç t√™n h·ªçc sinh:");
    const className = prompt("Nh·∫≠p l·ªõp:");

    if(!name || !className){
        alert("Thi·∫øu th√¥ng tin!");
        return;
    }

    const score = answerKey.length; // t·∫°m t√≠nh

    fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({
            name: name,
            className: className,
            score: score
        })
    })
    .then(res => res.json())
    .then(data => {
        alert("N·ªôp b√†i th√†nh c√¥ng!");
    })
    .catch(err => {
        alert("L·ªói g·ª≠i b√†i!");
        console.error(err);
    });
}
</script>
</body>
</html>